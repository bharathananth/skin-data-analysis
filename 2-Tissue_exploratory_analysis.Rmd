---
title: "Tissue-expressed genes"
author: "Marta del Olmo"
date: "2/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include=FALSE}
library(limma)
library(magrittr)
library(VennDiagram)
library(ggrepel)
library(ggforce)
library(tibble)
library(tidyr)
library(dplyr) #IDK why I have to load the packages in this chunk again
library(tidyr)
library(ggplot2)
library(grDevices)
library(ggvenn)
```

**This document explores the rhythmicity of genes in epidermis and dermis. We check how many rhythmic genes there are in each tissue, what their phases and amplitudes are, how they correlate between skin tissues, etc. Note that all these 'postporcessing' analyses are done with the null hypothesis $H_0$ being that tissue and subjects are independent factors, and that rhythms in dermis are the same as rhythms in epidermis. No sex information was included in the hypothesis testing so far.**

## **1. Comparison of rhythmic (and expressed) genes in Dermis vs. Epidermis**

Set cutoffs (like in BA's script)

```{r cutoffs}
fdr_cutoff <- 0.05
amp_cutoff <- log2(1 + 0.2) 
```

Load the raw data and the results of the fits ($H_0$ like BA's script, without sex information)

```{r load_data}
yave <- readRDS("visualize/data/rawdata.rds") #raw data after normalization and QC
results <- readRDS("visualize/data/results.rds") #results of fits (after lmFit, eBayes, topTable)
results %<>% 
  dplyr::mutate(A_D = sqrt(tissueD_inphase^2 + tissueD_outphase^2), 
  A_E = sqrt(tissueE_inphase^2 + tissueE_outphase^2),
  phaseD = atan2(tissueD_outphase, tissueD_inphase)*12/pi, 
  phaseE = atan2(tissueE_outphase, tissueE_inphase)*12/pi)
```

Now some exploratory analysis:

1. **Plot 1**: First we illustrate the overlap of rhythmic genes in dermis vs. epidermis (based on our cutoffs) 
    + <span style="color: blue;">1072 rhythmic genes in dermis OR epidermis </span>
    + <span style="color: blue;">206 rhythmic genes in both </span>
    + <span style="color: blue;">251 genes rhythmic only in D </span>
    + <span style="color: blue;">615 genes rhythmic only in E </span>

2. **Plot 2**: Comparison of amplitudes of rhythmic genes in epidermis vs dermis. Note that genes that are rhythmic in *either-or* tissue are plotted here (i.e., the 1072 genes). If we want to compare the amplitudes of genes that are rhythmic in both tissues (206), substitute `some_rhythm` for `both_rhythm`

3. **Plot 3**: Comparison of phases of rhythmic genes in epidermis vs dermis. Note that genes that are rhythmic in *either-or* tissue are plotted here (i.e., the 1072 genes). If we want to compare the phases of genes that are rhythmic in both tissues (206), substitute `some_rhythm` for `both_rhythm`

   + <span style="color: blue;">Phases clusted mainly in two peaks: at around 6 and -6 (both with `some_rhythm` and `both_rhythm`)  </span>

<span style="color: red;">I think I don't completely understand the FDR in `results` -> How can I check if a gene is expressed in epidermis or if it is expressed in dermis? Relates to the question in the next line of code `expressed`</span>
```{r plots}
expressed   <- dplyr::filter(results, adj_P_Val < fdr_cutoff) %$% ProbeName 
  #But how do I know if they are expressed in D or E?

both_rhythm <- dplyr::filter(results, A_D>amp_cutoff & A_E>amp_cutoff & adj_P_Val<fdr_cutoff) %$% ProbeName 
some_rhythm <- dplyr::filter(results, pmax(A_D, A_E) > amp_cutoff & adj_P_Val < fdr_cutoff) %$% ProbeName 
rhythm_D <- results[which(results$ProbeName %in% some_rhythm), ] %>% filter(A_D > amp_cutoff) %$% ProbeName
rhythm_E <- results[which(results$ProbeName %in% some_rhythm), ] %>% filter(A_E > amp_cutoff) %$% ProbeName

yrhy <- list(yrhy_D = yave$genes$ProbeName[yave$genes$ProbeName %in% rhythm_D], 
             yrhy_E = yave$genes$ProbeName[yave$genes$ProbeName %in% rhythm_E])

# ----- Venn diagram of rhythmic (expressed) genes in Dermis and Epidermis (either-or) -------
plot_Venn_compare_rhy <- ggvenn(yrhy, fill_color = c("#0073C2FF", "#EFC000FF"), 
                                stroke_size = 0.5, set_name_size = 4) +
  ggtitle('Rhythmic genes in Dermis and Epidermis')

if (!file.exists("figures/Venn_compare_rhy.pdf")){ 
  plot_Venn_compare_rhy %>% ggsave("figures/Venn_compare_rhy.pdf", .) 
} 
plot_Venn_compare_rhy

# ----- Comparison of amplitudes of the 1072 rhythmic genes in dermis OR epidermis, emphasis on clock genes ---- 
clock_genes <- c("PER1","PER2","PER3", "CRY1", "CRY2", "NR1D1", "NR1D2", "ARNTL", "ARNTL2", "CLOCK", 
                 "NPAS2","RORA","RORB","RORC", "CSNK1D", "CSNK1E", "DBP")

plot_Amplitude_compare <- ggplot(data = dplyr::filter(results, ProbeName %in% some_rhythm), 
                                 aes(x=2^A_D-1, y=2^A_E-1)) + #amps are in log2
  geom_point(aes(color=Symbol %in% clock_genes), size=1) + 
  geom_text_repel(aes(label=ifelse(Symbol %in% clock_genes, as.character(Symbol), "")), color="red", 
                  max.overlaps=Inf, box.padding = 0.5) + 
  scale_color_manual(values=c("black","red")) +
  theme_bw() + theme(aspect.ratio = 1, legend.position = "none") + coord_cartesian(xlim=c(0,1), ylim = c(0,1)) +
  xlab("Relative Amplitude -- Dermis") + ylab("Relative Amplitude -- Epidermis") +
  ggtitle("Amplitudes in Dermis (all rhythmic genes in dermis)\nvs Epidermis (all rhythmic genes in epidermis)")

if (!file.exists("figures/Amplitude_compare.pdf")){ 
  plot_Amplitude_compare %>% ggsave("figures/Amplitude_compare.pdf", .) 
} 
plot_Amplitude_compare

# ----- Comparison of phases of the 1072 rhythmic genes in dermis OR epidermis, emphasis on clock genes ----- 
plot_Phase_compare <- ggplot(data = dplyr::filter(results, ProbeName %in% some_rhythm), 
                             aes(x=phaseD, y=phaseE)) + 
  geom_point(aes(color=Symbol %in% clock_genes), size=1) + 
  geom_text_repel(aes(label=ifelse(Symbol %in% clock_genes, as.character(Symbol), "")), color="red", 
                  max.overlaps=Inf, box.padding = 0.5) + 
  scale_color_manual(values=c("black","red")) +
  theme_bw() + theme(aspect.ratio = 1, legend.position = "none") + geom_abline(slope = 1, alpha=0.2) + 
  scale_x_continuous(breaks = seq(-12,12,by = 6)) +
  scale_y_continuous(breaks = seq(-12,12,by = 6)) + 
  xlab("Phase -- Dermis") + ylab("Phase -- Epidermis")+
  ggtitle("Phases in Dermis (all rhythmic genes in dermis) vs\nEpidermis (all rhythmic genes in epidermis)")

if (!file.exists("figures/Phase_compare.pdf")){ 
  plot_Phase_compare %>% ggsave("figures/Phase_compare.pdf", .) 
} 
plot_Phase_compare
```

## **2. GO and Pathway Analysis in tissues**

### **2.1. Of genes that are rhythmic in either-or (together)**

<span style="color: red;">Double check that the code of the plot makes sense. x axis is percentage of differentially expressed `DE` genes (with respect to all of the genes enriched for a term `N`) whereas the size of the circle shows the total number of `DE`</span>

GO/KEGG analysis of genes that are rhythmic in dermis or epidermis (not making distinction) -> amp $>$ `amp_cutoff` (either-or), fdr $<$ `fdr_cutoff`

  + <span style="color: blue;">GO enrichment: circulatory system, rhythmic processes</span>
     + <span style="color: blue;">Analysis done with rhythmic genes in either-or</span>
     + <span style="color: blue;">p values in the order of 10e-4 -> not super significant?</span>
  + <span style="color: blue;">KEGG enrichment: rhythmic processes, immune-related pathways</span>
     + <span style="color: blue;">Analysis done with rhythmic genes in either-or</span>   
<span style="color: red;">Include activated/suppressed terms or pathways -> Have one grid for activated and another for inhibited. Muege had **dotplot function from baseR and an argument inside the function called `split=".sign", also add the `facet_grid(.~.sign)`**</span>
     
```{r, GO_together}
g <- goana(yave[yave$genes$ProbeName %in% some_rhythm,]$genes$EntrezID, universe = yave$genes$EntrezID) 
topGO(g, n=20, truncate.term = "42") # super significant terms have p values in the order of 10e-8
g %>% top_n(20, wt=-P.DE) %>% mutate(hits=DE*100/N) %>% 
    ggplot(aes(x=hits, y=Term, colour=P.DE, size=DE)) +
        geom_point() +
        expand_limits(x=0) +
        labs(x="Hits (%)", y="GO term", colour="p value", size="Count") +
    ggtitle("GO Term analysis on D+E") +
  theme_bw()

k <- kegga(yave[yave$genes$ProbeName %in% some_rhythm,]$genes$EntrezID, universe = yave$genes$EntrezID)
topKEGG(k, n=20, truncate.path = "42")
k %>% top_n(20, wt=-P.DE) %>% mutate(hits=DE*100/N) %>% 
    ggplot(aes(x=hits, y=Pathway, colour=P.DE, size=DE)) +
        geom_point() +
        expand_limits(x=0) +
        labs(x="Hits (%)", y="KEGG Pathway", colour="p value", size="Count") +
  scale_color_gradient(low="black", high="red") +
  ggtitle("KEGG Pathway analysis on D+E") +
  theme_bw()
```

### **2.2. Of genes rhythmic in one or another (separate)**
GO/KEGG analysis of genes that are rhythmic in dermis vs. GO analysis of genes that are rhythmic in epidermis (separate) -> amp $>$ `amp_cutoff` (either-or), fdr $<$ `fdr_cutoff`

  + <span style="color: blue;">GO enrichment in E: rhythmic processes, immune system, stress responses, secretion </span>
    + <span style="color: blue;">Analysis done with rhythmic genes in E</span>
    + <span style="color: blue;">p values in the order of 10e-5 -> not super significant?</span>
  + <span style="color: blue;">GO enrichment in D: DNA binding, transcriptional regulation, circadian, regulation of secretion/uptake, rhythmic processes</span>
    + <span style="color: blue;">Analysis done with rhythmic genes in D</span>
    + <span style="color: blue;">p values in the order of 10e-5 -> not super significant?</span>
  + <span style="color: blue;">KEGG enrichment in E: rhythmic pathways, cancer-related pathways </span>
    + <span style="color: blue;">Analysis done with rhythmic genes in E</span>    
  + <span style="color: blue;">KEGG enrichment in D: immune-related pathways, rhythmic pathways </span>
    + <span style="color: blue;">Analysis done with rhythmic genes in D</span>    

```{r, GO_separate}
# -------------- GO analysis -----------------
g_D <- goana(yave[yave$genes$ProbeName %in% rhythm_D,]$genes$EntrezID, universe = yave$genes$EntrezID) 
g_E <- goana(yave[yave$genes$ProbeName %in% rhythm_E,]$genes$EntrezID, universe = yave$genes$EntrezID) 

topGO(g_D, n=20, truncate.term = "42") # super significant terms have p values in the order of 10e-8
g_D %>% top_n(20, wt=-P.DE) %>% mutate(hits=DE*100/N) %>% 
    ggplot(aes(x=hits, y=Term, colour=P.DE, size=DE)) +
        geom_point() +
        expand_limits(x=0) +
        labs(x="Hits (%)", y="GO term", colour="p value", size="Count") +
  ggtitle("GO Term analysis on D") +
  theme_bw()

topGO(g_E, n=20, truncate.term = "42") 
g_E %>% top_n(20, wt=-P.DE) %>% mutate(hits=DE*100/N) %>% 
    ggplot(aes(x=hits, y=Term, colour=P.DE, size=DE)) +
        geom_point() +
        expand_limits(x=0) +
        labs(x="Hits (%)", y="GO term", colour="p value", size="Count") +
  ggtitle("GO Term analysis on E") +
  theme_bw()

# -------------- KEGG analysis -----------------
k_D <- kegga(yave[yave$genes$ProbeName %in% rhythm_D,]$genes$EntrezID, universe = yave$genes$EntrezID)
k_E <- kegga(yave[yave$genes$ProbeName %in% rhythm_E,]$genes$EntrezID, universe = yave$genes$EntrezID)

topKEGG(k_D, n=20, truncate.path = "42")
k_D %>% top_n(20, wt=-P.DE) %>% mutate(hits=DE*100/N) %>% 
    ggplot(aes(x=hits, y=Pathway, colour=P.DE, size=DE)) +
        geom_point() +
        expand_limits(x=0) +
        labs(x="Hits (%)", y="KEGG Pathway", colour="p value", size="Count") +
  scale_color_gradient(low="black", high="red") +
  ggtitle("KEGG Pathway analysis on D") +
  theme_bw()

topKEGG(k_E, n=20, truncate.path = "42")
k_E %>% top_n(20, wt=-P.DE) %>% mutate(hits=DE*100/N) %>% 
    ggplot(aes(x=hits, y=Pathway, colour=P.DE, size=DE)) +
        geom_point() +
        expand_limits(x=0) +
        labs(x="Hits (%)", y="KEGG Pathway", colour="p value", size="Count") +
  scale_color_gradient(low="black", high="red") +
  ggtitle("KEGG Pathway analysis on E") +
  theme_bw()
```

**TO DO:**

* Mueges tip on activated and suppressed pathways (also works with GO terms?)